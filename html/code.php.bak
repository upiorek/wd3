<?php

// Define base paths as constants
define('BASE_DIR', '/home/ubuntu/.wine/drive_c/Program Files (x86)/mForex Trader/MQL4/Files/');
define('ORDERS_DIR', BASE_DIR . 'php_orders');
define('EXECUTED_DIR', BASE_DIR . 'php_executed');
define('ACCOUNT_LOG_FILE', BASE_DIR . 'account_log.txt');

// Handle password verification AJAX request
function handlePasswordVerification() {
    if (isset($_POST['check_password'])) {
        // Clear any output buffers and disable error reporting to avoid contaminating JSON response
        while (ob_get_level()) {
            ob_end_clean();
        }
        error_reporting(0);
        
        $user = $_POST['user'];
        $password = $_POST['password'];
        $filename = isset($_POST['filename']) ? $_POST['filename'] : '';
        
        $password_file = '';
        if ($user === 'rafal') {
            $password_file = BASE_DIR . 'pass_r.txt';
        } elseif ($user === 'piotr') {
            $password_file = BASE_DIR . 'pass_p.txt';
        }
        
        $correct_password = '';
        if (file_exists($password_file)) {
            $correct_password = trim(file_get_contents($password_file));
        }
        
        $success = ($password === $correct_password);
        
        // If password is correct, create a file with user suffix next to the order file
        if ($success && !empty($filename)) {
            $original_file_path = ORDERS_DIR . '/' . $filename;
            
            if (file_exists($original_file_path)) {
                // Create filename with user suffix
                $file_info = pathinfo($filename);
                $base_name = $file_info['filename'];
                $extension = isset($file_info['extension']) ? '.' . $file_info['extension'] : '';
                $user_suffix = ($user === 'rafal') ? '_r' : '_p';
                $approval_filename = $base_name . $user_suffix . $extension;
                $approval_file_path = ORDERS_DIR . '/' . $approval_filename;
                
                // Create approval file with timestamp and user info
                $approval_content = "Approved by: $user\nTimestamp: " . date('Y-m-d H:i:s') . "\nOriginal file: $filename";
                file_put_contents($approval_file_path, $approval_content);
            }
        }
        
        header('Content-Type: application/json');
        echo json_encode(['success' => $success]);
        exit();
    }
}

// Display account log content
function displayAccountLog() {
    $original_file = ACCOUNT_LOG_FILE;
    
    if (file_exists($original_file) && is_readable($original_file)) {
        echo nl2br(htmlspecialchars(file_get_contents($original_file)));
    } else {
        echo "File not found.";
    }
}

// Display orders from php_orders folder
function displayOrders() {
    if (is_dir(ORDERS_DIR)) {
        $files = scandir(ORDERS_DIR);
        foreach ($files as $file) {
            // do not display approval files
            if ($file !== '.' && $file !== '..' && !preg_match('/_[rp]\.txt$/', $file)) {
                // Check if approval files exist
                $file_info = pathinfo($file);
                $base_name = $file_info['filename'];
                $extension = isset($file_info['extension']) ? '.' . $file_info['extension'] : '';
                
                $rafal_approval_file = ORDERS_DIR . '/' . $base_name . '_r' . $extension;
                $piotr_approval_file = ORDERS_DIR . '/' . $base_name . '_p' . $extension;
                
                $rafal_approved = file_exists($rafal_approval_file);
                $piotr_approved = file_exists($piotr_approval_file);
                
                // If both approvals exist, move files to executed folder
                if ($rafal_approved && $piotr_approved) {
                    // Create executed directory if it doesn't exist
                    if (!is_dir(EXECUTED_DIR)) {
                        mkdir(EXECUTED_DIR, 0755, true);
                    }
                    
                    $source_path = ORDERS_DIR . '/' . $file;
                    $target_path = EXECUTED_DIR . '/' . $file;
                    
                    // Move the original file
                    if (file_exists($source_path) && rename($source_path, $target_path)) {
                        chmod($target_path, 0666);
                        
                        // Also move the approval files
                        $rafal_target = EXECUTED_DIR . '/' . $base_name . '_r' . $extension;
                        $piotr_target = EXECUTED_DIR . '/' . $base_name . '_p' . $extension;
                        
                        if (file_exists($rafal_approval_file)) {
                            rename($rafal_approval_file, $rafal_target);
                            chmod($rafal_target, 0666);
                        }
                        if (file_exists($piotr_approval_file)) {
                            rename($piotr_approval_file, $piotr_target);
                            chmod($piotr_target, 0666);
                        }
                        
                        // Skip displaying this file since it's been moved
                        continue;
                    }
                }
                
                $rafal_class = $rafal_approved ? 'user-button approved' : 'user-button';
                $piotr_class = $piotr_approved ? 'user-button approved' : 'user-button';
                
                echo '<h3 class="file-name">' . htmlspecialchars($file) . ' ';
                echo '<button class="' . $rafal_class . '" onclick="checkPassword(\'' . $file . '\', \'rafal\', this)">Rafal</button>';
                echo '<button class="' . $piotr_class . '" onclick="checkPassword(\'' . $file . '\', \'piotr\', this)">Piotr</button>';
                echo '</h3>';
                echo '<div class="file-content">' . nl2br(htmlspecialchars(file_get_contents(ORDERS_DIR . '/' . $file))) . '</div>';
            }
        }
    } else {
        echo "Directory not found.";
    }
}

// Handle GET/POST requests and display messages
function handleRequests() {
    // Display success messages from GET parameters
    if (isset($_GET['created'])) {
        echo '<div style="color: green; margin-top: 10px;">File created successfully: ' . htmlspecialchars($_GET['created']) . '</div>';
    }

    if (isset($_POST['create_order'])) {
        $current_date = date('Y-m-d_H-i-s');
        $filename = $current_date . '.txt';
        $filepath = ORDERS_DIR . '/' . $filename;
        $order_type = isset($_POST['order_type']) ? $_POST['order_type'] : 'none';
        $content = $order_type;

        // Create directory if it doesn't exist
        if (!is_dir(ORDERS_DIR)) {
            mkdir(ORDERS_DIR, 0755, true);
        }
        
        // Create the file
        if (file_put_contents($filepath, $content) !== false) {
            echo '<div style="color: green; margin-top: 10px;">File created successfully: ' . htmlspecialchars($filename) . '</div>';
        } else {
            echo '<div style="color: red; margin-top: 10px;">Error creating file.</div>';
        }
    }
}

// Display executed orders
function displayExecutedOrders() {
    if (is_dir(EXECUTED_DIR)) {
        $files = scandir(EXECUTED_DIR);
        $found_files = false;
        foreach ($files as $file) {
            // Do not display approval files (_r or _p suffix)
            if ($file !== '.' && $file !== '..' && !preg_match('/_[rp]\.txt$/', $file)) {
                $found_files = true;
                echo '<h4>' . htmlspecialchars($file) . '</h4>';
                echo '<div class="file-content">' . nl2br(htmlspecialchars(file_get_contents(EXECUTED_DIR . '/' . $file))) . '</div>';
            }
        }
        if (!$found_files) {
            echo "No executed files found.";
        }
    } else {
        echo "Directory not found.";
    }
}

// Handle password verification first (before any HTML output)
handlePasswordVerification();

?>
